/**
 * Javascript controller for the "Actions" panel at the bottom of the page.
 *
 * @module     local_sharewith/copyactivity
 * @package    local_sharewith
 * @copyright  2018 Devlion <info@devlion.co>
 * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
 * @since      3.6
 */
define(["jquery","core/str","core/ajax","core/notification","local_sharewith/modal"],(function($,Str,Ajax,Notification,modal){var STORAGE={};return({init:function(){var root=document.querySelector("body");root.addEventListener("click",function(e){for(var target=e.target;root.contains(target);){if(target.classList.contains("selectCategory"))return void this.selectCategory();switch(target.dataset.handler){case"selectCourseForSection":this.selectCourseForSection(target);break;case"copySectionToCourse":this.copySectionToCourse();break;case"openShareWith":this.openShareWith(target);break;case"selectCourse":this.selectCourse(target);break;case"copyActivityToCourse":this.copyActivityToCourse();break;case"copyCourseToCategory":this.copyCourseToCategory()}target=target.parentNode}}.bind(this)),this.typeMessage()},selectCourseForSection:function(target){var sectionid=$(target).parents(".section").find('[data-itemtype="sectionname"]').data("itemid");STORAGE.sectionid=sectionid;var renderPopup=function(response){var context={copySection:!0,courses:JSON.parse(response.courses)};modal.render(modal.template.copyinstance,context).done(modal.triggerBtn.click())};Ajax.call([{methodname:"local_sharewith_get_courses",args:{},done:renderPopup,fail:Notification.exception}])},copySectionToCourse:function(){var modalContent,courseid=$(modal.modalContent).find(":selected").data("courseid");modal.addBtnSpinner();var renderPopup=function(response){var template=modal.template.error,context={title:M.util.get_string("eventsectioncopy","local_sharewith"),text:M.util.get_string("system_error_contact_administrator","local_sharewith")};response.result&&(template=modal.template.confirm,context={title:M.util.get_string("eventsectioncopy","local_sharewith"),text:M.util.get_string("section_copied_to_course","local_sharewith")}),modal.render(template,context)};Ajax.call([{methodname:"local_sharewith_add_sharewith_task",args:{courseid:Number(courseid),sourcecourseid:Number(this.getCurrentCourse()),sourcesectionid:Number(STORAGE.sectionid),type:"sectioncopy"},done:renderPopup,fail:Notification.exception}])},selectCourse:function(target){var self=this,renderPopup=function(response){var context={courses:JSON.parse(response.courses),copyActivity:!0};STORAGE.cmid=target.dataset.cmid,STORAGE.uid=target.dataset.uid,context.hidebackbtn=!0,modal.render(modal.template.copyinstance,context).done(modal.triggerBtn.click()).done(()=>{$(".courses").on("change",()=>{self.selectSection()})}).done(self.selectSection)};Ajax.call([{methodname:"local_sharewith_get_courses",args:{},done:renderPopup,fail:Notification.exception}])},selectSection:function(){var modalContent=$(modal.modalContent),courseid=modalContent.find(":selected").attr("data-courseid");courseid||(courseid=this.getCurrentCourse());var renderPopup=function(response){var sections=JSON.parse(response.sections);modalContent.find(".sections").html(""),sections.forEach((function(section){modalContent.find(".sections").append($("<option data-sectionid ="+section.section_id+">"+section.section_name+"</option>"))}))};Ajax.call([{methodname:"local_sharewith_get_sections",args:{courseid:Number(courseid)},done:renderPopup,fail:Notification.exception}])},copyActivityToCourse:function(){var modalContent=$(modal.modalContent),courseid=modalContent.find(".courses option:selected").attr("data-courseid"),sectionid=modalContent.find(".sections option:selected").attr("data-sectionid");modal.addBtnSpinner();var renderPopup=function(response){var context={title:M.util.get_string("eventdublicatetoteacher","local_sharewith")},template=modal.template.error;switch(response.result){case 0:context.text=M.util.get_string("system_error_contact_administrator","local_sharewith");break;case 1:context.text=M.util.get_string("error_coursecopy","local_sharewith");break;case 2:context.text=M.util.get_string("error_sectioncopy","local_sharewith");break;case 3:context.text=M.util.get_string("error_activitycopy","local_sharewith");break;case 4:context.text=M.util.get_string("error_permission_allow_copy","local_sharewith");break;case 10:context.text=M.util.get_string("activity_copied_to_course","local_sharewith"),template=modal.template.confirm}modal.render(template,context)};Ajax.call([{methodname:"local_sharewith_add_sharewith_task",args:{courseid:Number(courseid),sourcecourseid:Number(this.getCurrentCourse()),sectionid:Number(sectionid),sourceactivityid:Number(STORAGE.cmid),sourceuserid:Number(STORAGE.uid),type:"activitycopy"},done:renderPopup,fail:Notification.exception}])},selectCategory:function(){var renderPopup=function(response){var context={hidebackbtn:!0,copyCourse:!0,categories:JSON.parse(response.categories)},template=modal.template.copyinstance;response.result||(context={hidebackbtn:!0,copyCourse:!0,title:M.util.get_string("eventcoursecopy","local_sharewith"),text:M.util.get_string("no_accessible_category","local_sharewith")},template=modal.template.error),modal.render(template,context).done(modal.triggerBtn.click())};Ajax.call([{methodname:"local_sharewith_get_categories",args:{},done:renderPopup,fail:Notification.exception}])},copyCourseToCategory:function(){var categoryid=$(modal.modalContent).find(":selected").attr("data-categoryid"),renderPopup=function(response){var context={title:M.util.get_string("eventcoursecopy","local_sharewith"),text:M.util.get_string("system_error_contact_administrator","local_sharewith")},template=modal.template.error;response.result&&(context={title:M.util.get_string("eventcoursecopy","local_sharewith"),text:M.util.get_string("course_copied_to_section","local_sharewith")},template=modal.template.confirm),modal.render(template,context)};Ajax.call([{methodname:"local_sharewith_add_sharewith_task",args:{sourcecourseid:Number(this.getCurrentCourse()),categoryid:Number(categoryid),type:"coursecopy"},done:renderPopup,fail:Notification.exception}])},typeMessage:function(){var urlString=window.location.href,url,param=new URL(urlString).searchParams.get("swactivityname");if(param){var textarea=$('textarea[data-region="send-message-txt"]')[0],speed=30,data={activityname:param};Str.get_string("ask_question_before_copying","local_sharewith",data).done((function(message){var i=0;!function typeWriter(){if(i<message.length)textarea.innerHTML+=message.charAt(i),i++,setTimeout(typeWriter,30);else{var val=textarea.value;$(textarea).focus().val("").val(val)}}()})).fail(Notification.exception)}},getCurrentCourse:function(){var str,result;return $("body").attr("class").match(/course-\d+/gi)[0].replace(/\D+/,"")}})}));